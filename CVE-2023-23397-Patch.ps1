##############################################
# Name:CVE-2023-23397-Patch 
# Purpose: Patches CVE-2023-23397 on various versions of windows 10 and 11 (20H2, 22H2, 
# requirements:  Set-ExecutionPolicy Unrestricted
# Creator: Zep 
# Date: 2023-3-24
# Revision:v1 For non intune device deployment to put the latest MS pathces 
# https://msrc.microsoft.com/update-guide/releaseNote/2023-Mar
# https://www.catalog.update.microsoft.com/Home.aspx
##############################################

# Get the Windows version and hotfix numbers
$osVersion = [Environment]::OSVersion.Version
$hotfixNumbers = Get-HotFix | Select-Object -ExpandProperty HotFixID | Sort-Object | Select-Object -Last 3

# Check if the hotfix numbers meet the criteria
if ($hotfixNumbers -contains "KB5023696" -or $hotfixNumbers -contains "KB5023706" -or $hotfixNumbers -contains "KB5023702") {
    # Hotfixes are installed, display a message
    Write-Host "Hotfixes KB5023696, KB5023706, and KB5023702 are already installed on this system."
} else {
    # Hotfixes are missing, download and install them

    if ($osVersion.Build -eq "22621")
    {
        $url = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2023/03/windows11.0-kb5023706-x64_79f9cb602196d8152019690a7a67d6d3e9833165.msu"
    }
    elseif ($osVersion.Build -eq 17763 )
    {
        $url = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/secu/2023/03/windows10.0-kb5023702-x64_25c0d04726b1f92c46e76d371ca58875051506c5.msu"
    }
    else 
    {
        $url = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/secu/2023/03/windows10.0-kb5023696-x86_a7845063c7139f57fd99bc5550aa01260af2e800.msu"
    }
    New-item -Path "C:\Temp\" -ItemType Directory
    $path = "C:\Temp\hotfixes.msu"
    Invoke-WebRequest $url -OutFile $path
    Start-Process wusa.exe -ArgumentList "/quiet", "/norestart", $path -Wait
    Write-Host "Hotfixes KB5023696, KB5023706, and KB5023702 have been installed."
}
